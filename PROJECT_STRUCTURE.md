# Project Structure

This project follows **Clean Architecture** principles to ensure isolation of business logic from external concerns (HTTP, Database, Frameworks).

## Directory Tree

```text
.
├── cmd/
│   └── api/                # Application entry point
│       └── main.go         # Wire up dependencies and start the server
├── domain/                 # (Core) Business entities and repository interfaces
│   ├── account.go
│   ├── category.go
│   ├── tag.go
│   ├── tenant.go
│   ├── transaction.go
│   └── user.go
├── internal/
│   ├── api/                # Transport Layer (Adapters)
│   │   ├── handler/        # HTTP Handlers (controllers)
│   │   │   ├── account_handler.go
│   │   │   ├── auth_handler.go
│   │   │   ├── category_handler.go
│   │   │   ├── tag_handler.go
│   │   │   ├── tenant_handler.go
│   │   │   └── user_handler.go
│   │   ├── middleware/     # Auth, Tenant, Logging, CORS
│   │   ├── router/         # Route definitions and Scalar registration
│   │   └── dto/            # Data Transfer Objects (Request/Response structs)
│   │       ├── account_dto.go
│   │       ├── auth_dto.go
│   │       ├── category_dto.go
│   │       ├── tag_dto.go
│   │       ├── tenant_dto.go
│   │       └── user_dto.go
│   ├── service/            # Use Cases (Business Logic)
│   │   ├── account_service.go
│   │   ├── auth_service.go
│   │   ├── category_service.go
│   │   ├── tag_service.go
│   │   ├── tenant_service.go
│   │   └── user_service.go
│   ├── db/                 # Persistence Layer (Adapters)
│   │   └── postgres/       # SQL implementation using pgx
│   │       ├── account_repository.go
│   │       ├── category_repository.go
│   │       ├── db.go
│   │       ├── tag_repository.go
│   │       ├── tenant_repository.go
│   │       ├── transaction_repository.go
│   │       └── user_repository.go
│   ├── config/             # Configuration loading (env vars, .yaml)
│   └── auth/               # Identity Provider integration (Supabase Validator)
├── docs/                   # Documentation
│   └── swagger.yaml        # Auto-generated OpenAPI 3.0 specification
├── migrations/             # Database migrations
└── Makefile                # Automation commands
```

---

## Architectural Layers

### 1. Domain Layer (`/domain`)
The center of the application. It contains entities and repository interfaces. 
- **Rule**: This layer must **never** import anything from `internal`.
- **Validation**: Domain entities allow for self-validation via `IsValid()` methods, ensuring data integrity before persistence.
- **Entities**:
  - `User`, `Tenant`: Identity and access management.
  - `Account`, `Transaction`: Core financial data.
  - `Category`, `Tag`: Classification systems.

### 2. Service Layer (`/internal/service`)
Contains the business logic (Use Cases). It acts as an orchestrator between the API layer and the Domain.
- **Responsibility**: Orchestrates domain logic and implements business rules.
- **Dependency**: Receives and returns **Domain Entities** (or primitives). It should NOT know about DTOs.
- **Rule**: Pure business logic. No JSON tags, no validator tags, no web concerns.

### 3. Auth Package (`/internal/auth`)
Provides the **Validator** for Supabase JWTs.
- **Role**: Parses and verifies JWT tokens against the Supabase JWKS (JSON Web Key Set).
- **Usage**: Used by `AuthMiddleware` to validate requests.

### 4. API Layer (`/internal/api`)
Handles all HTTP-specific logic using the **Gin** framework. 
- **Handlers**: Act as a "Translator". They parse JSON into **DTOs** using Gin's binding, map those DTOs to **Domain Entities** to call the service, and map returned entities back to **Response DTOs**.
- **DTOs**: Located in `/internal/api/dto`. These contain the JSON tags, validation rules (using Gin's default validator), and OpenAPI annotations.
- **Scalar**: Integrated via `github.com/MarceloPetrucio/go-scalar-api-reference` to render the `docs/swagger.yaml` at the `/docs` endpoint.

---

## Data Flow & Mapping

To maintain strict isolation, mapping happens in the **API layer**:

1. **Request**: `JSON` → `Handler` → `mapping to Entity` → `Service`
2. **Response**: `Service` → `Domain Entity` → `Handler` → `mapping to DTO` → `JSON`

---

## Documentation (OpenAPI)
Documentation is automated using **swag**.
- **Annotations**: Handlers and DTOs are decorated with structured comments.
- **Automation**: The specification is generated by running `make swagger`, which creates `docs/swagger.yaml`.
- **Serving**: The API serves this file via the `/docs` endpoint using **Scalar**.
